# CSV 智能拆分工具 - 架构设计文档

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          CLI 层                                  │
│                        (fire.Fire)                               │
│                     split / list-fields                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────┴────────────────────────────────────┐
│                       控制层 (CLI)                               │
│  • 参数解析                                                      │
│  • 文件枚举                                                      │
│  • 流程编排                                                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────┴────────────────────────────────────┐
│                      核心业务层 (CSVSplitter)                    │
│  • 拆分策略选择                                                  │
│  • 字段分类处理                                                  │
│  • 递归/级联拆分                                                 │
└──┬──────────────────────────────────────────────────────────┬───┘
   │                                                          │
   │                    ┌─────────────┐                       │
   │                    │  二次拆分    │                       │
   │                    │  (行数控制)  │                       │
   │                    └─────────────┘                       │
   │                                                          │
┌──┴────────────────┐  ┌───────────────────┐  ┌──────────────┴──┐
│   DateUtils       │  │   FileUtils       │  │   输出处理       │
│  • 日期检测        │  │  • 编码检测        │  │  • 文件命名      │
│  • 格式转换        │  │  • 文件名安全      │  │  • 统计信息      │
│  • 周期分组        │  │  • 文件枚举        │  │  • 目录管理      │
└───────────────────┘  └───────────────────┘  └─────────────────┘
```

### 1.2 模块分层

| 层级 | 模块 | 职责 |
|-----|------|------|
| CLI 层 | CLI 类 | 命令行接口定义、参数解析 |
| 控制层 | CLI.split() | 流程编排、文件枚举 |
| 业务层 | CSVSplitter | 拆分策略执行、数据分组 |
| 工具层 | DateUtils / FileUtils | 日期处理、文件处理 |
| 基础层 | pandas / chardet / fire | 第三方库依赖 |

---

## 2. 核心类设计

### 2.1 类图

```
┌────────────────────────────────────────────────────────────────┐
│                              CLI                               │
├────────────────────────────────────────────────────────────────┤
│ + split(input, split_fields, time_period, ...)                 │
│ + list_fields(file, encoding)                                  │
└─────────────────────┬──────────────────────────────────────────┘
                      │ uses
┌─────────────────────┴──────────────────────────────────────────┐
│                         CSVSplitter                             │
├────────────────────────────────────────────────────────────────┤
│ - max_rows: int                                                │
│ - output_dir: str                                              │
│ - encoding: str                                                │
│ - stats: dict                                                  │
├────────────────────────────────────────────────────────────────┤
│ + split_single_file(file_path, split_fields, time_period)      │
│ - _split_by_size(df, base_name, suffix)                        │
│ - _classify_fields(df, split_fields)                           │
│ - _split_multi_non_date_fields(df, base_name, fields, ...)     │
│ - _split_multi_fields_with_date(df, base_name, ...)            │
│ - _split_by_non_date(df, base_name, field)                     │
│ - _split_by_date(df, base_name, date_field, period_type)       │
│ - _split_by_non_date_and_date(df, base_name, ...)              │
│ + print_summary()                                              │
└─────────────┬─────────────────────────────────┬────────────────┘
              │                                 │
┌─────────────┴──────────┐      ┌──────────────┴───────────────┐
│      DateUtils         │      │        FileUtils             │
├────────────────────────┤      ├──────────────────────────────┤
│ + detect_date_format() │      │ + detect_encoding()          │
│ + is_date_column()     │      │ + safe_filename()            │
│ + convert_to_datetime()│      │ + get_csv_files()            │
└────────────────────────┘      └──────────────────────────────┘
```

### 2.2 类职责说明

#### 2.2.1 CLI 类

**职责**：命令行接口层，负责参数解析和流程编排

**方法**：
| 方法 | 职责 |
|-----|------|
| `split()` | 主入口，解析参数并执行拆分流程 |
| `list_fields()` | 辅助功能，列出CSV文件的字段信息 |

#### 2.2.2 CSVSplitter 类

**职责**：核心业务逻辑，执行CSV拆分

**属性**：
| 属性 | 类型 | 说明 |
|-----|------|------|
| `max_rows` | int/None | 单文件最大行数阈值 |
| `output_dir` | str | 输出目录路径 |
| `encoding` | str | 文件编码 |
| `stats` | dict | 统计信息（文件数、行数、错误等）|

**核心方法**：

| 方法 | 职责 | 返回值 |
|-----|------|--------|
| `split_single_file()` | 拆分单个文件的入口 | - |
| `_split_by_size()` | 二次拆分（按行数） | List[(filename, rows)] |
| `_classify_fields()` | 字段分类（日期/普通） | Tuple[date_fields, non_date_fields] |
| `_split_multi_non_date_fields()` | 多普通字段级联拆分 | List[(filename, rows)] |
| `_split_multi_fields_with_date()` | 多字段+日期级联拆分 | List[(filename, rows)] |
| `_split_by_non_date()` | 单普通字段拆分 | List[(filename, rows)] |
| `_split_by_date()` | 单日期字段拆分 | List[(filename, rows)] |
| `_split_by_non_date_and_date()` | 一普通+一日期组合拆分 | List[(filename, rows)] |
| `print_summary()` | 打印统计摘要 | - |

#### 2.2.3 DateUtils 类

**职责**：日期相关的工具方法

| 方法 | 职责 |
|-----|------|
| `detect_date_format()` | 检测单个值的日期格式 |
| `is_date_column()` | 判断整列是否为日期类型（阈值80%） |
| `convert_to_datetime()` | 将Series转换为datetime类型 |

#### 2.2.4 FileUtils 类

**职责**：文件相关的工具方法

| 方法 | 职责 |
|-----|------|
| `detect_encoding()` | 检测文件编码 |
| `safe_filename()` | 生成安全的文件名 |
| `get_csv_files()` | 获取指定路径下的CSV文件列表 |

---

## 3. 数据流设计

### 3.1 总体数据流

```
┌─────────────┐
│  CSV 文件    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         读取 CSV (pandas)                │
│  • 编码检测 (chardet)                    │
│  • 异常编码重试 (utf-8/gbk/gb2312)       │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         字段分类                         │
│  • 识别日期字段                          │
│  • 识别普通字段                          │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         选择拆分策略                     │
│  • 单普通字段                            │
│  • 多普通字段级联                        │
│  • 普通字段+日期                         │
│  • 纯日期                                │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         执行数据分组                     │
│  • groupby (普通字段)                    │
│  • dt.to_period (日期字段)               │
│  • 递归拆分 (级联)                        │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         二次拆分（可选）                  │
│  • 检查行数阈值                          │
│  • 分块保存                              │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         保存文件                         │
│  • 生成文件名                            │
│  • UTF-8-BOM 编码                        │
└──────┬──────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         统计信息                         │
│  • 输出文件数                            │
│  • 总行数                                │
└─────────────────────────────────────────┘
```

### 3.2 拆分策略决策树

```
                    开始
                      │
                      ▼
            ┌─────────────────┐
            │   字段分类       │
            │ (日期/普通)      │
            └────────┬────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
    有日期字段?                无日期字段
        │                         │
        ▼                         ▼
  ┌──────────┐            ┌──────────┐
  │普通字段数?│            │普通字段数?│
  └────┬─────┘            └────┬─────┘
       │                       │
   ┌───┴───┐              ┌────┴────┐
   │0      │1             │1       │≥2│
   ▼       ▼              ▼         ▼
纯时间   字段+时间      单字段   多字段级联
拆分     拆分           拆分      拆分
       │
   ┌───┴───┐
   │       │
   ▼       ▼
│≥2      │其他
   ▼       ▼
多字段+时间  字段+时间
级联拆分    拆分
```

---

## 4. 关键算法设计

### 4.1 日期字段检测算法

```
function is_date_column(series, threshold = 0.8):
    1. 过滤空值 → non_null_series
    2. 如果全为空 → 返回 False
    3. 对每个非空值：
       - 调用 detect_date_format()
       - 匹配成功则计数
    4. 计算 ratio = 匹配数 / 总数
    5. 返回 ratio >= threshold
```

**支持的日期格式正则**：
```python
yyyyMMdd:       r'^\d{4}(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])$'
yyyy-MM-dd:     r'^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$'
yyyy/MM/dd:     r'^\d{4}/(0[1-9]|1[0-2])/(0[1-9]|[12][0-9]|3[01])$'
yyyyMMdd HH:mm:ss: r'^\d{4}(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])\s+([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$'
yyyy-MM-dd HH:mm:ss: r'^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])\s+([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$'
yyyy/MM/dd HH:mm:ss: r'^\d{4}/(0[1-9]|1[0-2])/(0[1-9]|[12][0-9]|3[01])\s+([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$'
```

**日期格式示例**：
| 格式类型 | 示例 |
|---------|------|
| yyyyMMdd | 20240115 |
| yyyy-MM-dd | 2024-01-15 |
| yyyy/MM/dd | 2024/01/15 |
| yyyyMMdd HH:mm:ss | 20240115 14:30:00 |
| yyyy-MM-dd HH:mm:ss | 2024-01-15 14:30:00 |
| yyyy/MM/dd HH:mm:ss | 2024/01/15 14:30:00 |

### 4.2 多字段级联拆分算法（递归）

```
function recursive_split(df, fields, level = 0):
    1. 终止条件：level >= len(fields)
       → 调用 _split_by_size() 保存文件

    2. 获取当前字段：current_field = fields[level]
    3. 获取唯一值：unique_values = df[current_field].unique()
    4. 对每个唯一值：
       a. 过滤子数据：sub_df = df[df[current_field] == value]
       b. 生成后缀：suffix += f"_{safe_value}"
       c. 递归调用：recursive_split(sub_df, fields, level + 1)
```

**时间复杂度**：O(n × d)，n 为行数，d 为字段层级深度

### 4.3 二次拆分算法

```
function split_by_size(df, max_rows):
    1. total_rows = len(df)
    2. 如果 max_rows 为 None 或 total_rows <= max_rows：
       → 直接保存整个文件
    3. 否则：
       num_parts = ceil(total_rows / max_rows)
       for i in range(num_parts):
           start_idx = i * max_rows
           end_idx = min((i+1) * max_rows, total_rows)
           part_df = df.iloc[start_idx:end_idx]
           保存为 {base_name}_part{i+1}.csv
```

---

## 5. 时间周期处理设计

### 5.1 时间周期支持矩阵

| 周期 | Pandas Period | 输出格式 | 说明 |
|-----|---------------|---------|------|
| Y | `dt.to_period('Y')` | `2024` | 按年 |
| H | 自定义 | `2024-H1` | 按半年（需自定义） |
| Q | `dt.to_period('Q')` | `2024-Q1` | 按季度 |
| M | `dt.to_period('M')` | `2024-01` | 按月 |
| HM | 自定义 | `2024-01-HM1` | 按半月（需自定义） |
| D | `dt.to_period('D')` | `2024-01-15` | 按日 |

### 5.2 新增周期处理逻辑

**半年周期（H）**：
```python
def get_half_year_period(date):
    year = date.year
    month = date.month
    half = 'H1' if month <= 6 else 'H2'
    return f'{year}-{half}'
```

**半月周期（HM）**：
```python
def get_half_month_period(date):
    year = date.year
    month = f'{date.month:02d}'
    half = 'HM1' if date.day <= 15 else 'HM2'
    return f'{year}-{month}-{half}'
```

---

## 6. 错误处理设计

### 6.1 错误分类与处理策略

| 错误类型 | 抛出位置 | 处理策略 |
|---------|---------|---------|
| 字段不存在 | `_classify_fields()` | 警告并跳过 |
| 无有效字段 | `split_single_file()` | 打印错误，跳过文件 |
| 编码检测失败 | `_read_csv()` | 依次尝试备选编码 |
| 日期转换失败 | `convert_to_datetime()` | 返回 NaT（空值） |
| 空日期值 | 各拆分方法 | 归入 `*_NULL.csv` |
| 输出目录权限 | `_prepare_output_dir()` | 抛出异常，终止程序 |

### 6.2 错误收集机制

```python
self.stats = {
    'total_files': 0,
    'total_rows': 0,
    'output_files': 0,
    'errors': []  # 错误信息收集
}
```

---

## 7. 性能考虑

### 7.1 内存使用

| 操作 | 内存占用 | 优化策略 |
|-----|---------|---------|
| 读取CSV | O(n) | 使用 pandas 内存优化 |
| 分组操作 | O(n) | pandas 内置优化 |
| 递归拆分 | O(d × n/k) | 深度优先，及时释放 |
| 文件写入 | O(n/k) | 流式写入 |

### 7.2 性能瓶颈分析

| 瓶颈点 | 影响 | 优化方向 |
|-------|------|---------|
| 大文件读取 | 首次加载时间 | 分块读取 |
| 日期解析 | CPU 密集 | 缓存解析结果 |
| 递归深度 | 栈空间 | 限制最大层级 |
| 文件I/O | 写入时间 | 批量写入 |

### 7.3 性能优化建议

1. **分块读取**：对于超大文件，使用 `chunksize` 参数
2. **类型优化**：指定列类型减少内存占用
3. **并行处理**：多文件可使用多进程
4. **惰性求值**：延迟非必要操作

---

## 8. 扩展性设计

### 8.1 扩展点

| 扩展点 | 说明 | 实现方式 |
|-------|------|---------|
| 新时间周期 | 添加新的时间分组方式 | 扩展 `_get_period_label()` |
| 新文件格式 | 支持 Excel/JSON | 抽象读取接口 |
| 自定义命名 | 用户定义输出文件名模板 | 命名模板解析器 |
| 输出过滤器 | 按条件过滤输出数据 | 在拆分前添加过滤层 |

### 8.2 插件机制建议

```
┌─────────────────────────────────────────────────┐
│                  CSVSplitter                    │
├─────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │ ReaderPlugin│  │SplitPlugin  │ │WriterPlugin││
│  │  (读取器)   │  │ (拆分策略)  │  │ (写入器)  │ │
│  └─────────────┘  └─────────────┘  └─────────┘ │
└─────────────────────────────────────────────────┘
```

---

## 9. 代码组织结构

```
split_csv_by_field/
├── csv_splitter.py          # 主程序
│   ├── DateUtils            # 日期工具类
│   ├── FileUtils            # 文件工具类
│   ├── CSVSplitter          # 核心拆分类
│   └── CLI                  # 命令行接口类
├── docs/                    # 文档目录
│   ├── 01-产品需求文档.md
│   ├── 02-架构设计文档.md
│   └── 03-可视化文档.md
├── tests/                   # 测试目录（待添加）
│   ├── test_date_utils.py
│   ├── test_file_utils.py
│   ├── test_splitter.py
│   └── test_cli.py
└── requirements.txt         # 依赖清单
```

---

## 10. 技术债务与改进建议

### 10.1 当前技术债务

| 问题 | 影响 | 建议 |
|-----|------|------|
| 递归深度无限制 | 大数据量可能栈溢出 | 添加深度限制 |
| 无单元测试 | 重构风险高 | 补充测试用例 |
| 硬编码编码列表 | 兼容性有限 | 配置化 |
| 错误处理不统一 | 调试困难 | 统一异常体系 |

### 10.2 架构改进建议

1. **引入配置管理**
   - 支持 YAML/JSON 配置文件
   - 环境变量支持

2. **引入日志系统**
   - 替代 print 语句
   - 支持日志级别和文件输出

3. **引入验证层**
   - 参数校验框架（如 pydantic）
   - Schema 验证

4. **引入缓存机制**
   - 日期解析结果缓存
   - 编码检测结果缓存

---

## 11. 部署架构

```
┌─────────────────────────────────────────────────┐
│                   用户终端                       │
│            (命令行 / 脚本调用)                   │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│              csv_splitter.py                    │
│                 (单文件部署)                     │
│  • 无需服务端                                     │
│  • 本地执行                                       │
│  • 输出到本地目录                                 │
└─────────────────────────────────────────────────┘
```

**部署特点**：
- 无需网络连接
- 无需数据库
- 无需服务器环境
- 可打包为独立可执行文件（PyInstaller）
