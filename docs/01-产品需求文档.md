# CSV 智能拆分工具 - 产品需求文档

## 1. 产品概述

### 1.1 产品定位
面向数据分析师、运营人员的命令行工具，用于快速将大型 CSV 文件按业务维度拆分为易于管理的小文件。

### 1.2 核心价值
- **高效处理**：支持百万级行数的大文件拆分
- **灵活拆分**：支持字段组合、时间周期多维度拆分
- **智能识别**：自动检测日期字段、文件编码
- **安全可靠**：文件名安全处理，编码兼容性强

---

## 2. 功能需求

### 2.1 拆分策略

| 策略类型 | 触发条件 | 描述 | 示例 |
|---------|---------|------|------|
| 单字段拆分 | 仅1个非日期字段 | 按单个字段值拆分 | 按"省份" → 广东.csv、浙江.csv... |
| 多字段级联拆分 | ≥2个非日期字段 | 按多个字段递归嵌套拆分 | 按"省份+城市" → 广东_广州.csv、广东_深圳.csv... |
| 字段+时间拆分 | 1个非日期字段 + 1个日期字段 | 先按字段拆分，再按时间周期拆分 | 按"省份+月份" → 广东_2024-01.csv... |
| 多字段+时间拆分 | ≥2个非日期字段 + 1个日期字段 | 多字段级联后按时间拆分 | 按"省份+城市+月份" → 广东_广州_2024-01.csv... |
| 纯时间拆分 | 仅1个日期字段 | 按时间周期拆分 | 按"季度" → 2024-Q1.csv、2024-Q2.csv... |

### 2.2 时间周期支持

| 周期类型 | 参数值 | 说明 | 输出示例 |
|---------|--------|------|---------|
| 年 | Y | 按年份拆分 | 2024.csv、2025.csv |
| 半年 | H | 按上半年(H1)/下半年(H2)拆分 | 2024-H1.csv、2024-H2.csv |
| 季度 | Q | 按季度拆分 | 2024-Q1.csv、2024-Q2.csv... |
| 月 | M | 按月份拆分（默认） | 2024-01.csv、2024-02.csv... |
| 半月 | HM | 按上半月(1-15日)/下半月(16-月末)拆分 | 2024-01-HM1.csv、2024-01-HM2.csv |
| 日 | D | 按日期拆分 | 2024-01-15.csv、2024-01-16.csv... |

**时间周期说明**：
- H（半年）：H1 = 1-6月，H2 = 7-12月
- HM（半月）：HM1 = 每月1-15日，HM2 = 每月16日至月末

### 2.3 大文件二次拆分

| 参数 | 说明 |
|-----|------|
| 不启用 | max_rows=None，保持完整文件 |
| 默认值 | max_rows=500000，超过50万行自动二次拆分 |
| 自定义 | max_rows=指定值，按指定行数拆分 |

**二次拆分命名规则**：
```
{原文件名}_{字段值}_part1.csv
{原文件名}_{字段值}_part2.csv
{原文件名}_{字段值}_part3.csv
...
```

### 2.4 字段分类逻辑

工具会自动将拆分字段分类为**日期字段**和**普通字段**：

**日期字段识别条件**：
- 至少 80% 的值符合日期格式
- 支持格式：
  - `yyyyMMdd`：20240115
  - `yyyy-MM-dd`：2024-01-15
  - `yyyy/MM/dd`：2024/01/15
  - `yyyyMMdd HH:mm:ss`：20240115 14:30:00
  - `yyyy-MM-dd HH:mm:ss`：2024-01-15 14:30:00
  - `yyyy/MM/dd HH:mm:ss`：2024/01/15 14:30:00

**分类影响**：
- 日期字段：支持按时间周期拆分
- 普通字段：按唯一值拆分

---

## 3. 命令行接口

### 3.1 拆分命令

```bash
python csv_splitter.py split [参数]
```

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|-----|------|-----|-------|------|
| --input | string | 是 | - | 输入文件或文件夹路径 |
| --split-fields | string | 是 | - | 拆分字段，逗号分隔（如："省份,结算日期"） |
| --time-period | string | 否 | M | 时间周期：Y/H/Q/M/HM/D |
| --max-rows | int | 否 | 500000 | 单文件最大行数，None=不拆分 |
| --output | string | 否 | ./split_data | 输出目录 |
| --recursive | bool | 否 | False | 是否递归处理子文件夹 |
| --encoding | string | 否 | auto | 文件编码：auto/utf-8/gbk/gb2312 |

### 3.2 字段查看命令

```bash
python csv_splitter.py list-fields --file <文件路径>
```

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| --file | string | 是 | CSV文件路径 |
| --encoding | string | 否 | 文件编码，默认auto |

**输出格式**：
```
📋 文件字段列表
============================================================
文件: data.csv
编码: utf-8

总字段数: 10
============================================================
  1. 📅 日期 | 订单日期        | 样例: 20240115
  2. 📅 日期 | 结算日期        | 样例: 2024-01-15
  3. 📝 普通 | 省份            | 样例: 广东
  4. 📝 普通 | 城市            | 样例: 深圳
  ...
```

---

## 4. 使用示例

### 4.1 基础用法

#### 查看文件字段
```bash
python csv_splitter.py list-fields --file orders.csv
```

#### 按单个字段拆分
```bash
python csv_splitter.py split --input orders.csv --split-fields "省份"
```
输出：`orders_广东.csv`、`orders_浙江.csv`、`orders_江苏.csv`...

#### 按月份拆分
```bash
python csv_splitter.py split --input orders.csv --split-fields "订单日期" --time-period M
```
输出：`orders_2024-01.csv`、`orders_2024-02.csv`...

### 4.2 高级用法

#### 字段 + 时间组合拆分
```bash
python csv_splitter.py split \
    --input orders.csv \
    --split-fields "省份,订单日期" \
    --time-period M
```
输出：`orders_广东_2024-01.csv`、`orders_广东_2024-02.csv`...

#### 多字段级联拆分
```bash
python csv_splitter.py split \
    --input orders.csv \
    --split-fields "省份,城市,网点"
```
输出：`orders_广东_深圳_南山点.csv`、`orders_广东_深圳_福田点.csv`...

#### 大文件二次拆分
```bash
python csv_splitter.py split \
    --input large_orders.csv \
    --split-fields "省份" \
    --max-rows 100000
```
输出：`orders_广东_part1.csv`（10万行）、`orders_广东_part2.csv`（10万行）...

#### 批量处理文件夹
```bash
python csv_splitter.py split \
    --input ./data/ \
    --split-fields "订单日期" \
    --time-period Q \
    --recursive
```

### 4.3 时间周期示例

| 命令 | 拆分结果 |
|-----|---------|
| `--time-period Y` | 2023.csv、2024.csv、2025.csv |
| `--time-period H` | 2024-H1.csv、2024-H2.csv |
| `--time-period Q` | 2024-Q1.csv、2024-Q2.csv、2024-Q3.csv、2024-Q4.csv |
| `--time-period M` | 2024-01.csv、2024-02.csv... |
| `--time-period HM` | 2024-01-HM1.csv、2024-01-HM2.csv... |
| `--time-period D` | 2024-01-15.csv、2024-01-16.csv... |

---

## 5. 处理逻辑细节

### 5.1 字段处理流程

```
输入字段列表 → 分类（日期/普通） → 确定拆分策略 → 执行拆分
```

| 字段组合 | 拆分策略 |
|---------|---------|
| 0个有效字段 | 报错退出 |
| 1个普通字段 | 按字段唯一值拆分 |
| ≥2个普通字段 | 级联拆分（递归） |
| 1个普通字段 + 1个日期字段 | 组合拆分（先字段后时间） |
| ≥2个普通字段 + 1个日期字段 | 级联后按时间拆分 |
| 仅1个日期字段 | 按时间周期拆分 |

### 5.2 日期处理逻辑

| 场景 | 处理方式 |
|-----|---------|
| 日期格式识别失败 | 尝试 pandas 自动解析 |
| 自动解析失败 | 尝试常见格式逐个解析 |
| 无效日期值 | 归类到 `_{字段}_NULL.csv` |
| 日期字段为空 | 跳过该行或归入 NULL 文件 |

### 5.3 文件名处理

**不安全字符替换**：
```
/ \ : * ? " < > |  →  _
```

**文件名长度限制**：最多 100 字符

### 5.4 编码检测逻辑

```
1. encoding='auto' → 使用 chardet 检测
2. 检测失败 → 依次尝试 utf-8、gbk、gb2312、latin1
3. 全部失败 → 报错退出
```

### 5.5 输出目录处理

| 场景 | 处理方式 |
|-----|---------|
| 目录不存在 | 自动创建 |
| 目录已存在 | 询问用户是否清空（y/n） |

### 5.6 统计信息

处理完成后输出：
- 输入文件数量
- 总行数
- 输出文件数量
- 输出目录路径
- 错误列表（如有）

---

## 6. 输出文件命名规则

### 6.1 标准命名
```
{原文件名}_{字段1值}_{字段2值}_{时间周期}.csv
```

示例：
- 单字段：`orders_广东.csv`
- 双字段：`orders_广东_深圳.csv`
- 含时间：`orders_广东_2024-01.csv`
- 含时间季度：`orders_广东_2024-Q1.csv`
- 含时间半月：`orders_广东_2024-01-HM1.csv`

### 6.2 二次拆分命名
```
{标准名}_part{序号}.csv
```

示例：
- `orders_广东_part1.csv`
- `orders_广东_part2.csv`

### 6.3 空值处理
```
{标准名}_NULL.csv
```

---

## 7. 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 字段不存在 | 警告并跳过该字段 |
| 无有效拆分字段 | 报错并跳过该文件 |
| 文件读取失败 | 尝试多种编码，全部失败则报错 |
| 无效日期值 | 归入 NULL 文件 |
| 输出路径无权限 | 报错并终止 |

---

## 8. 依赖环境

### 8.1 Python 版本
- Python 3.7+

### 8.2 依赖库

| 库名 | 版本 | 用途 |
|-----|------|------|
| pandas | - | CSV 读写与数据处理 |
| fire | - | 命令行接口 |
| tqdm | - | 进度条显示 |
| chardet | - | 编码检测 |

### 8.3 安装命令
```bash
pip install pandas fire tqdm chardet
```

---

## 9. 版本信息

| 版本 | 日期 | 说明 |
|-----|------|------|
| v1.3 | 2025-01-06 | 优化行数拆分逻辑 |
| v1.4 | 待发布 | 新增半年(H)、半月(HM)周期支持 |

---

## 10. 后续改进方向

1. **配置文件支持** - 支持配置文件避免重复输入参数
2. **更多文件格式** - 支持 Excel、JSON 等格式
3. **GUI 界面** - 提供图形化操作界面
4. **单元测试** - 完善测试覆盖
5. **性能优化** - 支持流式处理超大文件
6. **输出模板** - 支持自定义输出文件名模板
